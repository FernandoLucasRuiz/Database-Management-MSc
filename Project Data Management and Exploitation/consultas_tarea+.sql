# 1 Resultado agrupado de los pacientes por las propiedades sexo y rango de edad. AYUDA: Se puede hacer más de un JOIN sobre la misma tabla. El resultado debería ser parecido a esta tabla:
select p1.nombre as sexo, p2.nombre as 'rango de edad', count(m.codigo) as 'n muestras' from b3b2_muestra as m 
inner join
(select muestra, nombre from b3b2_muestra_propiedad mp inner join b3b2_propiedad p on mp.propiedad = p.id where p.tipo = 'sexo') as p1 
on m.codigo=p1.muestra
inner join 
(select muestra, nombre from b3b2_muestra_propiedad mp inner join b3b2_propiedad p on mp.propiedad = p.id where p.tipo = 'rango de edad') as p2
on p1.muestra = p2.muestra
group by p1.nombre, p2.nombre
;

# 2 Número de genes que participan en la rutas que contenta la palabra 'platelet'. Simplemente hay que devolver el número.
select count(g.gene_ensembl) as "numero de genes" from b3b2_gen as g
inner join b3b2_gen_pathway as gp on g.gene_ensembl=gp.gen
inner join b3b2_pathway as p on gp.pathway=p.codigo
where p.descripcion like '%platelet%';

# 3 Muestras de las que no tenemos resultados de expresión. Basta con devolver el código de la muestra.
select m.codigo as muestras from b3b2_muestra as m
left join b3b2_expresion as e on m.codigo = e.muestra
where e.expresion is null;

# 4 Media de expresión de los genes secuenciados. Devolverá el gene_symbol y la media de expresión global.
select g.gene_symbol, avg(e.expresion) as "Media expresion global" from b3b2_expresion as e
inner join b3b2_gen as g on e.gen = g.gene_ensembl
group by e.gen;

# 5 Número de pathways de los genes que tienen media de expresión mayor de 25. Sólo debe devolver un número.
select sum(t.cuenta) as "Número de pathways" from (
select count(p.codigo) as cuenta from b3b2_expresion as e
inner join b3b2_gen as g on e.gen = g.gene_ensembl
inner join b3b2_gen_pathway as gp on gp.gen=g.gene_ensembl
inner join b3b2_pathway as p on p.codigo=gp.pathway
group by e.gen
having avg(e.expresion) > 25
) as t;

# 6 Muestras de las que no tenemos alguna propiedad (o sexo o rango de edad). Basta con devolver el código de la muestra.
select m.codigo as codigo_muestra from b3b2_muestra as m
left join
    (select muestra from b3b2_muestra_propiedad as mp inner join b3b2_propiedad as p on mp.propiedad = p.id where p.tipo = 'sexo') as sexo
on m.codigo = sexo.muestra
left join  
    (select muestra from b3b2_muestra_propiedad as mp inner join b3b2_propiedad as p on mp.propiedad = p.id where p.tipo = 'rango de edad') as rango
on m.codigo = rango.muestra
where sexo.muestra is null or rango.muestra is null;

# 7 Número de muestras por run. Deberá devolver una tabla parecida a esta:
select r.nombre as run, count(m.codigo) as "n muestras" from b3b2_muestra as m
inner join b3b2_muestra_run as mr on m.codigo=mr.muestra
inner join b3b2_run as r on mr.run = r.nombre
group by r.nombre;

# 8 Consulta que devuelva los genes cuyo log2foldchange sea mayor de 1 en valor absoluto entre muestras con sexo hombre y muestras con sexo mujer. Deberá de devolver el gene_symbol y el valor de log2foldchange.
select exp_mujer.gene_symbol, (log2(media_mujer/media_hombre)) as log2fc from
(select g.gene_symbol, avg(e.expresion) as media_mujer from b3b2_expresion as e
left join b3b2_gen as g on e.gen = g.gene_ensembl
inner join b3b2_muestra as m on e.muestra = m.codigo 
inner join b3b2_muestra_propiedad as mp on m.codigo = mp.muestra
inner join b3b2_propiedad as p on mp.propiedad = p.id where p.tipo = "sexo" and p.nombre = "Mujer"
group by e.gen) as exp_mujer
inner join 
(select g.gene_symbol, avg(e.expresion) as media_hombre from b3b2_expresion as e
left join b3b2_gen as g on e.gen = g.gene_ensembl
inner join b3b2_muestra as m on e.muestra = m.codigo 
inner join b3b2_muestra_propiedad as mp on m.codigo = mp.muestra
inner join b3b2_propiedad as p on mp.propiedad = p.id where p.tipo = "sexo" and p.nombre = "Hombre"
group by e.gen) as exp_hombre 
on exp_mujer.gene_symbol = exp_hombre.gene_symbol
where abs(log2(media_mujer/media_hombre)) > 1
;

